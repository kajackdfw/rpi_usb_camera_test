{% extends "base.html" %}

{% block title %}Camera {{ camera_id|default(0) }}{% endblock %}

{% block head %}
<!-- Streams-specific CSS (includes main.css via @forward) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/streams.min.css') }}">
{% endblock %}

{% block content %}
<article class="stream-card">
    <div class="camera-card-header">
        <h3>
            <span>Slot {{ camera_id|default(0) }} Live View</span>
            {% if camera_type %}
            <span class="camera-type-badge">{{ camera_type }}</span>
            {% endif %}
        </h3>
        <div class="camera-subtitle">
            MJPEG Stream
        </div>
    </div>

    <!-- Camera Live Stream -->
    <div class="camera-snapshot" id="stream-container">
        <div id="stream-loading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; background: var(--pico-muted-border-color);">
            <p>Loading camera stream...</p>
            <p style="font-size: 0.9rem; color: var(--pico-muted-color);">Please wait</p>
        </div>
        <!-- No src attribute initially - prevents browser from fetching before JS is ready -->
        <img id="video-stream" style="display: none; max-width: 100%; height: auto;" alt="Camera {{ camera_id|default(0) }} Stream">
        <div id="stream-error" style="display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; background: var(--pico-muted-border-color); color: var(--pico-del-color);">
            <p><strong>âš  Camera stream unavailable</strong></p>
            <p style="font-size: 0.9rem;">Retrying...</p>
        </div>
    </div>

    <!-- Status Badge and Controls -->
    <div class="camera-actions">
        <div id="stream-status" class="status-badge w-1-3" style="background: var(--pico-muted-border-color); color: var(--pico-muted-color);">
            <span style="display: flex; align-items: center; gap: 0.375rem; justify-content: center;">
                <i data-lucide="loader" style="width: 1.125rem; height: 1.125rem;"></i>
                <span>Connecting...</span>
            </span>
        </div>

        <div class="btn-wrapper w-2-3">
            <div style="display: flex; gap: 0.5rem;">
                <button class="secondary" onclick="window.location.reload()" style="flex: 1;">
                    <span style="display: flex; align-items: center; gap: 0.375rem; justify-content: center;">
                        <i data-lucide="refresh-cw" style="width: 1rem; height: 1rem;"></i>
                        <span>Refresh</span>
                    </span>
                </button>
                <button class="outline" onclick="redirect('/lan/api/snapshot')" style="flex: 1; margin: 0;">
                    <span style="display: flex; align-items: center; gap: 0.375rem; justify-content: center;">
                        <i data-lucide="camera" style="width: 1rem; height: 1rem;"></i>
                        <span>Snapshot</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Info -->
    <div class="camera-info">
        <div><strong>Stream Type:</strong> MJPEG</div>
        <div><strong>Refresh Rate:</strong> Real-time</div>
        <div><strong>Resolution:</strong> {% if properties.width and properties.height %}{{ properties.width }}x{{ properties.height }}{% else %}N/A{% endif %}</div>
        <div><strong>Status:</strong> Active</div>
    </div>
</article>

<!-- Back Button -->
<div style="text-align: center; margin-top: 2rem;">
    <a href="/lan/streams" role="button" class="secondary">
        <span style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
            <i data-lucide="arrow-left" style="width: 1.125rem; height: 1.125rem;"></i>
            <span>Back to All Streams</span>
        </span>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Redirect helper function
    function redirect(url) {
        window.location.href = url;
    }

    const videoStream = document.getElementById('video-stream');
    const loadingDiv = document.getElementById('stream-loading');
    const errorDiv = document.getElementById('stream-error');
    const statusBadge = document.getElementById('stream-status');

    function updateStatus(state, icon, text, color) {
        if (!statusBadge) {
            console.warn('Status badge not found');
            return;
        }

        const iconEl = statusBadge.querySelector('i');
        const textEl = statusBadge.querySelector('span span:last-child');

        if (iconEl) {
            iconEl.setAttribute('data-lucide', icon);
        } else {
            console.warn('Icon element not found');
        }

        if (textEl) {
            textEl.textContent = text;
        } else {
            console.warn('Text element not found');
        }

        statusBadge.className = 'status-badge w-1-3 ' + state;

        if (color) {
            statusBadge.style.background = color.bg;
            statusBadge.style.color = color.text;
        }

        // Refresh Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function loadStream() {
        console.log('Loading video stream...');
        updateStatus('active', 'video', 'Streaming', { bg: '#d4edda', text: '#155724' });

        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        videoStream.src = '/lan/video_feed?t=' + timestamp;

        // Show stream
        if (loadingDiv) loadingDiv.style.display = 'none';
        if (errorDiv) errorDiv.style.display = 'none';
        if (videoStream) videoStream.style.display = 'block';
        console.log('Video stream loaded');
    }

    // Simple approach: wait 500ms for camera to be ready, then load
    setTimeout(loadStream, 500);
</script>
{% endblock %}
