{% extends "base.html" %}

{% block title %}Camera Streams{% endblock %}

{% block head %}
<!-- Streams-specific CSS (includes main.css via @forward) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/streams.min.css') }}">
{% endblock %}

{% block content %}
<div class="content-container">
    <h2>{{ rover_name }} - Cameras</h2>

    <div class="camera-grid">
    {% for camera in cameras %}
    <article class="camera-card">
        <div class="camera-card-header">
            <h3>
                <span>Slot {{ camera.slot }}</span>
                {% if camera.enabled %}
                <span class="camera-type-badge">{{ camera.type }}</span>
                {% endif %}
            </h3>
            <div class="camera-subtitle">
                {{ camera.name }}
            </div>
        </div>

        {% if camera.active %}
        <!-- Active camera - show live snapshot -->
        <div class="camera-snapshot" onclick="location.href='/lan/stream/{{ camera.slot }}'">
            <img id="snapshot-{{ camera.slot }}"
                 src="/lan/api/snapshot?t={{ range(1, 10000) | random }}"
                 alt="{{ camera.name }} Snapshot">
            <div class="snapshot-overlay">
                Click to view live stream
            </div>
        </div>
        {% else %}
        <!-- Inactive camera -->
        <div class="camera-snapshot inactive">
            {% if camera.has_snapshot %}
            <!-- Show last captured frame -->
            <img src="/lan/api/snapshot/{{ camera.slot }}?t={{ range(1, 10000) | random }}"
                 alt="{{ camera.name }} Last Frame">
            <div class="last-frame-badge">Last frame</div>
            {% else %}
            <!-- Show placeholder -->
            <div class="camera-placeholder">
                <div class="placeholder-icon">ðŸ“·</div>
                <div class="placeholder-text">
                    {% if camera.enabled %}
                        {% if camera.exists %}Camera Interface {{ camera.device }}{% else %}Device Not Found{% endif %}
                    {% else %}
                        Not Configured
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="camera-actions">
            <div class="status-badge w-1-3 {% if camera.active %}active{% else %}inactive{% endif %}">
                <span style="display: flex; align-items: center; gap: 0.375rem; justify-content: center;">
                    {% if camera.active %}
                        <i data-lucide="toggle-right" style="width: 1.125rem; height: 1.125rem;"></i>
                        <span>Active</span>
                    {% else %}
                        <i data-lucide="toggle-left" style="width: 1.125rem; height: 1.125rem;"></i>
                        <span>Inactive</span>
                    {% endif %}
                </span>
            </div>

            {% if camera.enabled %}
                {% if camera.active %}
                <!-- Already streaming this camera -->
                <div class="btn-wrapper w-2-3">
                    <button class="outline" onclick="redirect('/lan/stream/{{ camera.slot }}')">
                        <span style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <i data-lucide="video" style="width: 1.25rem; height: 1.25rem;"></i>
                            <span>View Stream</span>
                        </span>
                    </button>
                </div>
                {% else %}
                <!-- Can switch to this camera -->
                <div class="btn-wrapper w-2-3">
                    <button class="outline" onclick="switchCamera({{ camera.slot }})">
                        <span style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <i data-lucide="camera" style="width: 1.25rem; height: 1.25rem;"></i>
                            <span>Use this Camera</span>
                        </span>
                    </button>
                </div>
                {% endif %}
            {% else %}
            <!-- Camera not configured -->
            <div class="btn-wrapper">
                <a href="/lan/settings" role="button">
                    <span style="display: flex; align-items: center; gap: 0.375rem; justify-content: center;">
                        <i data-lucide="settings" style="width: 1rem; height: 1rem;"></i>
                        <span>Configure</span>
                    </span>
                </a>
            </div>
            {% endif %}
        </div>

        <div class="camera-info">
            <div><strong>Device:</strong> {{ camera.device }}</div>
            {% if camera.enabled %}
                <div><strong>Type:</strong> {{ camera.type_name }}</div>
                {% if camera.exists %}
                    {% if camera.model_id and camera.vendor_id %}
                    <div><strong>USB ID:</strong> {{ camera.vendor_id }}:{{ camera.model_id }}</div>
                    {% endif %}
                {% else %}
                    <div><strong>USB ID:</strong> n/a</div>
                {% endif %}
            {% else %}
                <div><strong>Type:</strong> Not Set</div>
                <div><strong>USB ID:</strong> n/a</div>
            {% endif %}
        </div>
    </article>
    {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Redirect helper function
    function redirect(url) {
        window.location.href = url;
    }

    // List of active camera slots (generated server-side)
    const activeCameras = {{ (cameras | selectattr('active') | map(attribute='slot') | list) | tojson }};

    let snapshotErrorCount = 0;
    const maxSnapshotErrors = 3;

    // Auto-refresh snapshots every 5 seconds for active cameras only
    const snapshotInterval = setInterval(() => {
        activeCameras.forEach(slot => {
            refreshSnapshot(slot);
        });
    }, 5000);

    function refreshSnapshot(slot) {
        const img = document.getElementById('snapshot-' + slot);
        if (!img) return;

        // Preload the new image before swapping it in (prevents flickering)
        const timestamp = new Date().getTime();
        const newImg = new Image();

        newImg.onload = () => {
            // Once loaded, swap in the new image source
            img.src = newImg.src;
            // Reset error count on success
            snapshotErrorCount = 0;
        };

        newImg.onerror = () => {
            snapshotErrorCount++;
            console.warn('Failed to load snapshot for slot', slot, '(error', snapshotErrorCount, 'of', maxSnapshotErrors, ')');

            // If we get multiple consecutive errors, stop trying and show a message
            if (snapshotErrorCount >= maxSnapshotErrors) {
                console.error('Camera appears to be offline, stopping snapshot refresh');
                clearInterval(snapshotInterval);

                // Optionally show an overlay on the snapshot
                const container = img.closest('.camera-snapshot');
                if (container && !container.querySelector('.camera-offline-notice')) {
                    const notice = document.createElement('div');
                    notice.className = 'camera-offline-notice';
                    notice.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 1rem; border-radius: 0.5rem; text-align: center;';
                    notice.innerHTML = '<p><strong>âš  Camera Offline</strong></p><p style="font-size: 0.9rem; margin-top: 0.5rem;">Refresh the page to reconnect</p>';
                    container.style.position = 'relative';
                    container.appendChild(notice);
                }
            }
            // Keep the old image on error - don't update
        };

        // Start loading the new snapshot
        newImg.src = '/lan/api/snapshot?t=' + timestamp;
    }

    async function switchCamera(slot) {
        try {
            const response = await fetch('/api/switch-camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slot: slot })
            });

            const data = await response.json();

            if (data.success) {
                location.reload();  // Reload to update UI
            } else {
                alert('âœ— Error: ' + (data.error || 'Failed to switch camera'));
            }
        } catch (error) {
            alert('âœ— Network error: ' + error.message);
        }
    }
</script>
{% endblock %}
